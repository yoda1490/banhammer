<?php
// Read configuration from environment variables or use defaults
$db_host = getenv('DB_HOST') ?: 'localhost';
$db_user = getenv('DB_USER') ?: 'fail2ban';
$db_pwd = getenv('DB_PASSWORD') ?: 'fail2ban';
$database = getenv('DB_NAME') ?: 'fail2ban';
$table = getenv('DB_TABLE') ?: 'fail2ban';

mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

// Opens a connection to a MySQL server
try {
    $link = mysqli_connect($db_host, $db_user, $db_pwd);
} catch (mysqli_sql_exception $e) {
    outputDbError('DB_CONNECT', 'Database connection failed', $e->getMessage());
}

// Set the active MySQL database
try {
    mysqli_select_db($link, $database);
} catch (mysqli_sql_exception $e) {
    outputDbError('DB_SELECT', 'Database selection failed', $e->getMessage());
}

function outputDbError($code, $message, $details)
{
    header('Content-Type: application/json');
    http_response_code(500);
    echo json_encode([
        'error' => $code,
        'message' => $message,
        'details' => $details,
    ]);
    exit;
}

// Set the webServer variable for CORS headers (used in get.php)
if (!isset($webServer)) {
    $webServer = getenv('WEB_SERVER') ?: '*';
}

if (!isset($adminTokenHash)) {
    $adminTokenHash = getenv('ADMIN_TOKEN_HASH') ?: '';
}

?>
